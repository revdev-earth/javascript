# 14. Storage and Persistence

En desarrollo web, persistencia significa guardar datos de forma que puedan recuperarse despuÃ©s, incluso si el usuario recarga la pÃ¡gina o cierra el navegador.

Los navegadores ofrecen varias opciones de almacenamiento, cada una con sus ventajas, limitaciones y casos de uso.

## 1. localStorage

Almacenamiento clave/valor en el navegador.

- Persistente hasta que el usuario lo borre manualmente.
- Capacidad aproximada: 5â€“10 MB segÃºn el navegador.
- Solo almacena strings (necesario serializar objetos con JSON.stringify).

```javascript
// Guardar
localStorage.setItem("theme", "dark");

// Recuperar
const theme = localStorage.getItem("theme");

// Eliminar
localStorage.removeItem("theme");
```

ðŸ’¡ **Uso tÃ­pico:** guardar configuraciones de usuario, estado de la interfaz, tokens no sensibles.

## 2. sessionStorage

Igual que localStorage pero solo dura mientras la pestaÃ±a/ventana estÃ¡ abierta.

- Capacidad similar (5â€“10 MB).

```javascript
sessionStorage.setItem("sessionId", "abc123");
console.log(sessionStorage.getItem("sessionId"));
```

ðŸ’¡ **Uso tÃ­pico:** datos temporales que no deben persistir entre sesiones (p.ej. formularios en progreso).

## 3. IndexedDB

Base de datos NoSQL en el navegador.

- Permite almacenar datos complejos (objetos, blobs, binarios).
- Capacidad: centenas de MB o mÃ¡s, dependiendo del navegador.
- Acceso asÃ­ncrono.

```javascript
// Ejemplo bÃ¡sico
const request = indexedDB.open("MiDB", 1);

request.onupgradeneeded = (event) => {
  const db = event.target.result;
  db.createObjectStore("usuarios", { keyPath: "id" });
};

request.onsuccess = () => {
  const db = request.result;
  const tx = db.transaction("usuarios", "readwrite");
  tx.objectStore("usuarios").add({ id: 1, nombre: "Nico" });
};
```

ðŸ’¡ **Uso tÃ­pico:** aplicaciones offline, almacenamiento masivo, cachÃ© de datos de API.

## 4. WebSQL (ðŸš« Deprecado)

- API SQL en el navegador.
- Obsoleta, pero aÃºn soportada en algunos navegadores antiguos.
- Reemplazada por IndexedDB.

## 5. Cookies

Datos pequeÃ±os enviados al servidor en cada request HTTP.

- Capacidad: ~4 KB.
- Pueden tener fecha de expiraciÃ³n.
- Usar con cuidado: afectan el rendimiento si se abusa de ellas.

```javascript
// Crear cookie
document.cookie = "user=Nico; path=/; max-age=3600";

// Leer cookies
console.log(document.cookie);
```

ðŸ’¡ **Uso tÃ­pico:** sesiones de usuario, flags de autenticaciÃ³n, seguimiento.

## 6. Cache API (Service Workers)

Almacena respuestas de red (HTML, JS, imÃ¡genes, etc.) para usarlas offline.

- Usado en Progressive Web Apps (PWA).

```javascript
// Dentro de un Service Worker
self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open("v1").then((cache) => {
      return cache.addAll(["/", "/index.html", "/styles.css"]);
    })
  );
});
```

ðŸ’¡ **Uso tÃ­pico:** mejorar rendimiento y permitir acceso offline.

## 7. Storage Quotas

El lÃ­mite depende del navegador y del tipo de almacenamiento:

- **Cookies:** ~4 KB
- **localStorage/sessionStorage:** 5â€“10 MB
- **IndexedDB:** hasta el 60% del espacio libre del disco.

Los navegadores pueden borrar datos de IndexedDB o Cache API si falta espacio (excepto si se marca como persistente).

## 8. Estrategias de persistencia

- **VolÃ¡til** â†’ datos en memoria o sessionStorage.
- **Persistente** â†’ localStorage, IndexedDB, Cache API.
- **Sincronizada con servidor** â†’ guardar en cliente + API REST/GraphQL.
- **Offline-first** â†’ IndexedDB + Cache API + sincronizaciÃ³n en segundo plano (Background Sync).

### Ejemplo estrategia offline-first:

```javascript
async function saveNoteOffline(note) {
  const db = await openDB("notes", 1, {
    upgrade(db) {
      db.createObjectStore("notes", { keyPath: "id" });
    },
  });
  await db.put("notes", note);
  if (navigator.onLine) {
    await fetch("/api/notes", { method: "POST", body: JSON.stringify(note) });
  }
}
```

### ðŸ“Œ Resumen comparativo:

| API            | TamaÃ±o mÃ¡x. | Persistencia | Sincroniza con servidor | Estructura de datos |
| -------------- | ----------- | ------------ | ----------------------- | ------------------- |
| localStorage   | 5â€“10 MB     | SÃ­           | No                      | String clave/valor  |
| sessionStorage | 5â€“10 MB     | No           | No                      | String clave/valor  |
| IndexedDB      | Alto        | SÃ­           | No (manual)             | Objetos, blobs      |
| Cookies        | ~4 KB       | SÃ­           | SÃ­ (automÃ¡tica)         | String clave/valor  |
| Cache API      | Alto        | SÃ­           | No (manual)             | Respuestas HTTP     |
