# 29. Progressive Web Apps (PWA)

Una **PWA** es una aplicación web que usa capacidades modernas del navegador para:

- Funcionar **offline**.
- Ser **instalable** en escritorio y móvil.
- Ofrecer **rendimiento similar a una app nativa**.

Se apoyan principalmente en **Service Workers**, un **App Manifest** y buenas prácticas de rendimiento.

## 1. Service Worker Strategies

El **Service Worker** es un script que el navegador ejecuta en segundo plano, separado del hilo principal.

### Funciones clave:

- Cachear recursos.
- Interceptar y responder solicitudes.
- Sincronización en segundo plano.
- Manejo de notificaciones push.

### Estrategias comunes de cacheo:

| Estrategia                 | Descripción                                                    | Ejemplo                  |
| -------------------------- | -------------------------------------------------------------- | ------------------------ |
| **Cache First**            | Usa lo que esté en caché, y si no, pide a la red.              | Íconos, CSS estático.    |
| **Network First**          | Usa la red, y si falla, recurre a la caché.                    | Datos de API.            |
| **Stale-While-Revalidate** | Muestra caché inmediatamente, pero actualiza en segundo plano. | Contenido semi-estático. |
| **Cache Only**             | Solo usa caché.                                                | Archivos inmutables.     |
| **Network Only**           | Siempre red.                                                   | Datos en tiempo real.    |

**Ejemplo de Service Worker simple:**

```javascript
self.addEventListener("install", (event) => {
  event.waitUntil(
    caches
      .open("app-cache")
      .then((cache) => cache.addAll(["/", "/index.html", "/styles.css"]))
  );
});

self.addEventListener("fetch", (event) => {
  event.respondWith(
    caches
      .match(event.request)
      .then((response) => response || fetch(event.request))
  );
});
```

## 2. App Manifest

Archivo `manifest.json` que describe la app al sistema operativo o navegador.

**Ejemplo:**

```json
{
  "name": "Mi PWA",
  "short_name": "PWA",
  "start_url": "/index.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#317EFB",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    }
  ]
}
```

**Esto habilita:**

- Pantalla de inicio personalizada.
- Tema y colores.
- Iconos para diferentes resoluciones.

## 3. Offline Functionality

- El **Service Worker** intercepta solicitudes y responde desde caché si no hay conexión.
- Modelo común: **App Shell**.
  - El _shell_ (HTML, CSS, JS base) se carga siempre desde caché.
  - El contenido dinámico se obtiene desde la red.

## 4. Push Notifications

- Permiten enviar mensajes desde el servidor a la PWA incluso cerrada.
- Requiere **permiso del usuario**.
- Se implementa con **Push API** y **Service Workers**.

**Ejemplo de envío desde el SW:**

```javascript
self.registration.showNotification("Nuevo mensaje", {
  body: "Tienes un nuevo mensaje en tu bandeja",
  icon: "/icon.png",
});
```

## 5. App Shell Model

- **Concepto**: Cachear la estructura base (UI estática) y luego rellenar datos dinámicamente.
- **Beneficio**: carga instantánea en visitas posteriores.

## 6. Installation Prompts

- Los navegadores modernos pueden mostrar un **prompt de instalación** si la app cumple:
  - Servida por HTTPS.
  - Manifest.json válido.
  - Service Worker activo.

**Ejemplo para controlar el evento:**

```javascript
let deferredPrompt;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Mostrar botón de "Instalar"
});
```

## Beneficios de una PWA

- Carga rápida.
- Funciona sin conexión.
- Experiencia tipo app nativa.
- Menos fricción que publicar en App Store.

## Limitaciones

- Acceso limitado a APIs nativas (comparado con apps nativas).
- Soporte incompleto en algunos navegadores (ej: Safari móvil).
